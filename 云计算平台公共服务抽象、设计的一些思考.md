##云计算平台公共服务抽象、设计的一些思考

###概述
软件系统通常是随着业务需求逐步发展的，系统架构师的认知体系、组织职责划分等影响系统设计的因素也是逐步变化的，当时最符合需求的设计，放在一个更大更完整的视角和一个更长周期内看，往往显得苍白无力。文章围绕这云计算平台公共服务抽象设计为来聊一聊抽象和设计的一些思路。

###问题由来
一个复杂的软件系统，怎么做抽象、设计，是架构师需要面对最棘手的问题。系统设计有点类似于我们的城市规划，我们期望是这样的
![alt-txt](https://share.nos-eastchina1.126.net/g1.png)

但实际上，建成的样子往往是这样的
![alt-txt](https://share.nos-eastchina1.126.net/g2.png)

问题出在哪里？当然有成本（当前有什么资源就做什么事情,包含时间、人力、工具等等）、技术（新技术层出不穷）的因素，但根因在于我们系统通常是随着业务需求逐步发展的（如城市的扩张受到经济发展逐步推动），系统架构师的认知体系、组织职责划分等影响系统设计的因素也是逐步变化的，当时最符合需求的设计，放在一个更大更完整的视角和一个更长周期内看，往往显得苍白无力。架构师也是人，没有上帝视角和能力。

###解决办法和关于云平台价值思考
找到了原因，就有改进的办法。我觉得可以从两个方面去考虑，一个是架构师要有意识不断调整和完善我们看系统视角，这些视角，可以是从系统本身内部各种细节设计实现到外部更宏观角度，可以是从系统关系到的各种组织、人员的角度，也可以从昨天问题今天总结到明天发展预测的角度等等，优化对系统的抽象，从而保证系统生命力；另一个方面，需要设定好一些基本设计原则和规范，不至于熵增在系统发展过程中完全不受控。

接下来以云计算为例，来聊一聊这两点。大家知道云计算本身是一个提供了众多iaas、paas产品的平台型系统。云计算平台最重要的基座是以计算、存储、网络虚拟化为核心各项技术（iaas），其次是以各种开源中间件为核心构建功能丰富的paas服务，这些技术和服务是公司众多业务线所依赖的基础设施，当然也是云计算的核心价值和竞争力。但是今天我们要讨论并不是这些技术，而是云计算平台为这些技术产品化过程中提供的一些公共服务的价值、抽象和设计思考。平台是云计算各种技术产品化的重要载体，做好平台各项公共服务的抽象和设计，对服务好平台上技术产品，让他们更好专注自身的核心竞争力，进而为公司战略产品提供稳定、可靠专业的云服务，至关重要；另外，对保障云计算本身产品形态的完整性、稳定性，提供灵活组合和可扩展能力，为公司做好成本管理等工作也非常重要。后面我站在平台架构师和公共服务负责人的角度，来跟大家聊一聊云平台中公共服务的抽象和设计的一些思考。

###云平台的抽象和抽象原则

首先来看下已抽象出来一些公共服务
![alt-txt](https://share.nos-eastchina1.126.net/g3.png)

以上这些公共服务，我们可以归成这么几类：

1、平台内一些公共的基础依赖。

用户服务，认证服务，权限服务等，这些比较好理解，不展开。

2、面向用户开放更多能力、产品形态标准化的抽象。

比如说资源池服务。云计算用户特别是大用户，为了保持业务的稳定可靠安全，有独占资源需求、也有灵活调整资源的需求。但是原来我们的物理资源都是平台事先规划好的（以二级az形式），paas、iaas的资源调度只能基于事先的规划进行。用户根本没有机会参与资源调度的过程，对资源选择、使用和管理也没有任何灵活性。面对这样的情况，iaas提供了基于标签（tag）的调度方式，（跟原来二级az比）这是一种非常灵活的方式。但是标签的管理和调度比较复杂而且易变，同时还要考虑不同服务使用不同的存储、副本域等情况。不做一定的抽象封装，对用户来说难于理解，对产品自身来说资源如何定价、产品形态如何暴露也都是很大的问题。因此我们抽象出了机型、节点类型和资源池三个对用户暴露的概念，并在资源池服务中实现了对这三种对象的管理。

![alt-txt](https://share.nos-eastchina1.126.net/g4.png)

这种抽象，既满足用户购买、使用和管理资源的灵活性和稳定性，又隐藏掉tag管理和调度的复杂性和易变性。有点类似于将资源管理和调度的设计翻译成了用户可理解语言，让用户对此有了一个具体和清晰的认知载体，因此也可以看成是对产品形态的标准化抽象。

3、系统分层抽象

分层抽象的重要性不言而喻，我们去看计算机体系结构、各种网络协议、以及软件开发中经典MVC模型，无一不体现出分层设计的思想。分层意味这每一层的封装和标准化。

![alt-txt](https://share.nos-eastchina1.126.net/g5.png)

云计算中，iaas、paas是一种分层。作为iaas解决方案的openstack本身有非常多的灵活性，但是作为产品往外提供的时候，应该做一定的封装。从paas角度看，iaas也可以是产品。如果虚机的管理服务结合资源池，直接提供资源池层级的和宿主机层级的调度能力，不仅可以保证调度灵活性，也能为他们封装掉iaas底层调度方案的复杂性和易变性。这是资源池服务作为iaas和paas之间分层抽象价值所在。

api网关作为平台对外统一的能力提供层。云计算内部有iaas、paas服务，还有用户认证、订单、计费等公共服务，这些服务能力既可以通过web可视化形式对用户提供，也可以通过api的形式提供给用户调用。所以云计算平台自身分层也很重要。api网关实现了用户身份验证、权限验证、服务治理、日志审计等功能，封装了平台所有对外提供服务的产品的能力和调用姿势。用户可以根据网关开放（各云产品）的能力构建适合自身业务的web管控平台。

把平台分层再简化抽象一下，我们看到的分层是下面这样的。

![alt-txt](https://share.nos-eastchina1.126.net/g9.png)

这里我们再放飞一下思想，以一个更大的视角来看看公司职能部门分层设计，这里我们主要关注一下传统it企业开发运维分层模式vs基于云计算和逐步践行devops业务开发运维分层模式的区别。

传统的开发运维分层是这样的（当前我们情况）

![alt-txt](https://share.nos-eastchina1.126.net/g6.png)

传统分层模式，服务标准化建在运维层（oss）。因为运维拿到机房交付的机器，他要负责环境初始化、资源分配、权限管理、网络连通性、资源状态监控、预警、扩缩容等等工作。对外以工单、哨兵、cmdb、天秤等封装成标准化的服务。这在以物理资源为主体的运维服务中，看上去这是一个很合理标准分层。

但是云计算实际上重新定义了资源组织和交付的形态，可以更有效的被管理、更产品化，所以比较理想分层其实是这样的

![alt-txt](https://share.nos-eastchina1.126.net/g7.png)

这看上去有点像社会化的分层，其实除了客户更集中，服务质量更好更贴身之外，完全可以把私有云看成了网易内部的公有云。跟以运维为主的oss标准化体系相比，原来运维系统工程师负责的环境初始化、资源分配、权限管理、网络连通性、资源状态监控、预警、扩缩容等功能，在云计算产品体系里，已经是开放给用户的标准能力了。因此拿基于云计算组织分层跟基于传统运维为中心的组织分层相比，有点像降维打击。但由于一些历史因素和云计算本身能力完备性因素，目前还没有达到比较理想的状态。但是我觉得随着公司运营往更社会化方式推进（内部结算、自负盈亏，降本增效、开源节流），往更社会化组织分层方向的演进，我认为是一种大概率事件，也是应该推进的一个方向。

4、业务领域抽象经验借鉴

充分调研和借鉴已有业务领域知识和抽象模型，不仅可以让我们少走很多弯路，也能让我们专注自身业务特殊需求和创新。云计算相关的领域，既包含iaas相关计算、存储、网络虚拟化为核心的技术领域，也包含一些通用业务领域，比如计费体系设计，18年重构我们把原来计费系统按领域经验模型拆分成定价、订单、出账、支付结算等服务，进而明确了每个服务的核心模型，一下子整个架构就清晰了不少；核心出账服务也参照电信运营商核心出账逻辑进行设计，从而大大提升了出账准确性、可靠性和灵活性，这些都体现了特定领域知识和经验借鉴带来的价值。而且领域经验的参考，往往可以给你指明一些方向，比如定价、订单、出账、结算这些，我们只要再往前走一步，很容易就能满足建设云应用商店、云市场的需求。不管是技术领域还是业务领域，掌握更多的领域相关知识，既要有认知深度，又要有认知广度，是进行借鉴或者抽象创新的前提。

总结一下抽象的原则：

1、通用性。主要是指云产品都有的相同或类似的需求，比如用户、认证、权限等，他的核心价值对内体现在降低重复建设成本、运营成本和协作成本上；对外则体现在用户理解、对接的成本上。

2、必要性。必要性是指是否有必要对平台内部一些逻辑进行抽象封装。比如资源池服务，抽象的价值往往体现在对用户价值上，对内反而会有一些成本。

3、合理分层，他的价值体现在系统的扩展性、稳定性，以及组织运作的降本增效上。比如api网关、资源池等。

4、充分借鉴已有业务领域抽象经验。别人已经建好了桥，就不要再趟水过去了。

系统抽象是一个阶段性和持续的一个过程，在一个业务快速发展的领域，一个牛逼的架构师抽象出能管三年架构，那他差不多就接近上帝了。通常来说我们需要根据上面这些原则，持续不断的进行迭代。

###云平台公共服务的设计的原则

抽象出一个服务后，如何做好服务的设计，也是很重要的一点。接下来我们来聊一聊公共服务的设计原则。

1、基础完备性。横向服务职责能力从规划和设计来说必须是完整和闭环的。比如用户服务，它应该提供用户注册、查询、修改、注销等能力，这是用户自身生命周期管理的基本要求。当然，完备性无关乎服务大小，只不过对象越小，考虑状态越简单，对象越大，要考虑的东西越多而已。比如在系统分层抽象中，把云计算平台看成一层，要完成它的完备性，就是一个庞大的工程。但这仍然是设计必须要完成的。

2、内聚性。公共服务不应该对其他服务存在依赖或只应该存在最小依赖。首先，公共服务本身就是为云产品提供服务的，不能反过来依赖各项产品。即使不得不依赖，也应该遵循依赖倒置原则。比如欠费停服服务，他的核心价值是给运营提供自定义不同用户、产品欠费停服的规则的能力，但是怎么对这些产品采取停服、清理资源等操作，则应该定义开放性接口来进行。这好比像kubernetes的设计，它本身并不关心用什么容器、存储，通过开放CRI、CNI和CSI这些标准接口保证自身开放性。另外，各公共服务相互之间之间也不应该有过多的依赖。

3、开放性。任何云产品应该根据与公共服务达成一致的协议来使用公共服务提供的能力，双方都只受到协议的约束。这里的协议可以不是内聚性里强调的开放接口（这个很多时候是单方决定的），一般来说可以把应用之间交互协议建在适配层（见下图）。这样的协议，从内往外看，可以保证公共服务自身足够的稳定性；从外往内看，可以看到足够的灵活性。此外，协议的设计要遵从solid相关设计原则。

![alt-txt](https://share.nos-eastchina1.126.net/g8.png)

4、领域驱动设计。看到上面这个经典的六边形架构，自然不得不提到DDD设计思想。领域抽象上文提到过，不过这里要强调的是DDD不仅是一种经验论，更是一种方法论规约论。前者强调的是要借鉴别人的在特定业务领域的实践经验和抽象设计，后者强调的是领域模型设计本身要遵从一定的模式和规范。这些规范包括使用通用语言、限界上下文、六边形架构、实体、领域服务、领域事件等等沟通、设计方法，从而保证领域模型的稳定、可扩展和可继承。DDD最终产出的是关于某个特定业务领域的软件模型，这些模型能被有同样知识背景的人所理解、复用和改进，这有利于领域知识的沉淀和积累，也有利于业务持续发展。这更接近于我们从书上学到的DDD的认知。如果深入去读DDD的相关书籍，你会发现DDD有很多OO思想的实践，DDD的方法论规约论本身有点像业务领域的OO设计的一个泛型抽象。不管是经验论还是方法论规约论，掌握更多的业务领域知识，尊重业务领域知识，同时掌握DDD规约论设计思想，把核心领域模型积累沉淀下来，这不仅能体现出技术人员设计能力，也是业务系统的核心价值。

5、遵从云平台服务的通用设计原则和规范。云计算数据面和控制面都有SLA曾诺，公共服务设计要能支持云产品满足SLA的需求。这里对公共服务主要指的就是可靠性和性能的要求。虽然公共服务大多数是global的服务，但为了满足性能和可靠性的需求，我们采用跟云产品管控端类似的部署结构。

横向服务的设计规范（最佳实践举例）
横向服务的接入协议（最佳实践举例）

以上这些设计原则和规范，能让公共服务聚焦自身逻辑的准确性、灵活性、开放性和可靠性，保证平台整体形态的稳定和可扩展；也能让云产品高效的接入使用这些能力，助力云产品聚焦于自身核心竞争力提升。 当然这些原则本身并不限于公共服务（而且相关原则也不只这些），之所以摘出来讲，主要公共横向服务设计中，这些是基础且关键的原则。甚至我觉得任何提供公共服务的系统、组织都应该遵从这些原则。

###问题拓展思考
以上的这些，更多的是从云平台自身角度出发提出的一些的设计和抽象原则、想法。实际上，如果站在不同的视角再进行一些思考，可以发现更多问题。比如站在用户的视角看云计算，用户希望资源足够弹性、独立安全、灵活互通、稳定可靠、成本更低 等等，每个看上去都合理，但是又有些矛盾。现实中我们提供了公有云、私有云、专属云等等不同形态的云和不同的用户体系。这其实也是一种抽象，只不过是比较偷懒的一种。是不是有这些云就解决所有问题了呢，并没有。比如云资源或用户体系划分越细弹性不足的问题、不同用户体系间资源隔离及互通问题、考拉封板影响其他用户升级需求的问题等等…，这些问题到一定的阶段肯定还是需要做更高层次抽象和设计。

前两天正好看到因总裁办转发而大火的文章《#华为云#听从你心，无问西东》（https://news.cnblogs.com/n/621733/） 以及引发的一系列评论，说到底谈的也是华为云整体规划和抽象的问题，只不过它要面临的问题更庞大更复杂：从私有云跟公有云的关系，从微观技术产品到宏观商业模式，再到产品竞争力和生态构建等等，总之槽点满满观点尖锐。而总裁办把这样一篇边吐槽边思考的文章和评论转发出来，引发大家思考和讨论，恰恰说明华为正从顶层设计上思考这些问题。其实一定程度上也体现了对任总所倡导的让听得见炮火声音的人来做决策的指导思想的反思，云计算并不像运营商业务和终端业务一样有非常清晰的商业模式，云计算看上去这样做也可以，那样做也可以，因此需要考虑市场需求和一定程度清晰的顶层设计之间的平衡，才能发挥出最大的价值。

写到这里，希望能引发大家的一些思考。也希望有一天，在坐的各位架构师，在各自的领域，往成为上帝的路上更近一步。最后祝网易云计算在大家共同努力下能逐步发展成一个稳定可靠、持续创新、功能完备、应对灵活的云计算平台。